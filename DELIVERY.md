# 納品・デプロイガイド

このドキュメントは、勤怠管理システムを納品先に引き渡す際の手順書です。

## 📦 納品物の確認

以下のファイルとディレクトリが含まれていることを確認してください：

```
kinntai_y/
├── public/              # フロントエンドファイル
├── routes/              # APIルート
├── services/            # ビジネスロジック
├── middleware/          # ミドルウェア
├── scripts/             # ユーティリティスクリプト
├── server.js            # メインサーバーファイル
├── config.js            # 設定ファイル
├── package.json         # 依存関係
├── .env.example         # 環境変数テンプレート
├── README.md            # 基本ドキュメント
├── SETUP.md             # セットアップガイド
├── DELIVERY.md          # このファイル（納品ガイド）
└── DEPLOYMENT_GUIDE.md  # デプロイ手順書（詳細版）
```

## ⚠️ 重要: 納品パターンの選択

納品する際は、以下の3つのパターンから選択してください。**パターンによって管理責任が異なります**。

## 🚀 デプロイ方法の選択

納品先の技術レベルと要件に応じて、以下のいずれかの方法を選択してください。

### 方法A: Railway（推奨・最も簡単）

**対象**: 技術者・非技術者問わず、最も簡単にデプロイ可能

**メリット**:

- 無料プランあり
- GitHubと連携して自動デプロイ
- 環境変数の設定が簡単
- HTTPS自動対応

**手順**:

1. [Railway](https://railway.app/) にアカウント作成
2. 「New Project」→「Deploy from GitHub repo」
3. このリポジトリを選択
4. 環境変数を設定（後述）
5. デプロイ完了後、自動生成されたURLを確認

### 方法B: Render

**対象**: 技術者向け、無料プランあり

**メリット**:

- 無料プランあり
- GitHubと連携
- 自動デプロイ

**手順**:

1. [Render](https://render.com/) にアカウント作成
2. 「New」→「Web Service」
3. GitHubリポジトリを接続
4. 設定：
   - Build Command: `npm install`
   - Start Command: `npm start`
5. 環境変数を設定
6. デプロイ

### 方法C: 自社サーバー（VPS）

**対象**: 技術者向け、自社サーバーを所有している場合

**手順**:

1. サーバーにNode.jsをインストール
2. リポジトリをクローン
3. `npm install` で依存関係をインストール
4. `.env` ファイルを設定
5. PM2などでプロセス管理
6. Nginxでリバースプロキシ設定（オプション）

## ⚙️ 環境変数の設定

### Railway / Render の場合

デプロイプラットフォームの環境変数設定画面で、以下を設定：

```
GOOGLE_SHEETS_SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_SHEETS_JSON_PATH=./service-account.json
PORT=3000
JWT_SECRET=強力なランダム文字列（本番環境用）
```

**重要**: `service-account.json` ファイルは、Railway/Renderのファイルシステムにアップロードする必要があります。
または、環境変数で直接設定することも可能です（後述）。

### サービスアカウントJSONファイルのアップロード方法

#### Railway の場合

1. Railwayのプロジェクト画面で「Variables」タブを開く
2. 「Files」セクションで `service-account.json` をアップロード
3. 環境変数 `GOOGLE_SHEETS_JSON_PATH` を `./service-account.json` に設定

#### Render の場合

1. Renderのサービス画面で「Environment」タブを開く
2. 「Secret Files」セクションで `service-account.json` をアップロード
3. 環境変数 `GOOGLE_SHEETS_JSON_PATH` を `./service-account.json` に設定

### 環境変数で直接設定する場合（JSONファイルを使わない）

以下の環境変数を設定：

```
GOOGLE_SHEETS_SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_SHEETS_CLIENT_EMAIL=your_service_account_email@project.iam.gserviceaccount.com
GOOGLE_SHEETS_PRIVATE_KEY="-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n"
PORT=3000
JWT_SECRET=強力なランダム文字列
```

**注意**: `GOOGLE_SHEETS_PRIVATE_KEY` は、改行文字を `\n` として記述し、全体をダブルクォートで囲んでください。

## 📋 デプロイ前チェックリスト

- [ ] Google Sheets APIの認証設定が完了している
- [ ] スプレッドシートに必要なシート（Employees, AttendanceLog）が作成されている
- [ ] サービスアカウントにスプレッドシートの編集権限が付与されている
- [ ] 環境変数が正しく設定されている
- [ ] `JWT_SECRET` が本番環境用の強力な文字列に変更されている
- [ ] テスト用のユーザーが作成されている（オプション）

## 🔐 セキュリティチェックリスト

- [ ] `JWT_SECRET` が推測困難な文字列になっている
- [ ] `.env` ファイルが `.gitignore` に含まれている（Git管理外）
- [ ] サービスアカウントのJSONファイルがGit管理外になっている
- [ ] 本番環境のURLがHTTPSになっている

## 🧪 デプロイ後の確認

1. **アプリケーションにアクセス**

   - デプロイされたURLにアクセス
   - ログイン画面が表示されることを確認
2. **ログイン機能の確認**

   - テストユーザーでログインできることを確認
   - 管理者ユーザーでログインできることを確認
3. **打刻機能の確認**

   - 出勤ボタンが動作することを確認
   - 退勤ボタンが動作することを確認
   - スプレッドシートにデータが記録されることを確認
4. **管理者機能の確認**

   - 管理者でログイン
   - 勤怠一覧が表示されることを確認
   - 従業員一覧が表示されることを確認

## 📱 スマホからのアクセス

デプロイ後は、スマホから以下のURLにアクセスできます：

```
https://your-app-name.railway.app
```

**注意**: 同じWi-Fiネットワークに接続する必要はありません。インターネット経由でアクセス可能です。

## 🆘 トラブルシューティング

### アプリケーションが起動しない

1. 環境変数が正しく設定されているか確認
2. ログを確認（Railway/Renderのログ画面）
3. `service-account.json` ファイルが正しくアップロードされているか確認

### ログインできない

1. スプレッドシートの `Employees` シートにユーザーが存在するか確認
2. パスワードハッシュが正しく設定されているか確認
3. `is_active` が `TRUE` になっているか確認

### 打刻データが記録されない

1. サービスアカウントにスプレッドシートの編集権限が付与されているか確認
2. `AttendanceLog` シートが存在するか確認
3. シートのヘッダーが正しいか確認

### エラーログの確認方法

#### Railway

- プロジェクト画面の「Deployments」タブ
- 各デプロイの「View Logs」をクリック

#### Render

- サービス画面の「Logs」タブ

## 📞 サポート

問題が発生した場合は、以下の情報を確認してください：

1. エラーメッセージの全文
2. ログの内容
3. 環境変数の設定内容（機密情報は除く）
4. スプレッドシートの状態

## 📝 追加の設定

### カスタムドメインの設定

Railway/Renderでは、カスタムドメインを設定できます。詳細は各プラットフォームのドキュメントを参照してください。

### バックアップ

スプレッドシートのデータは自動的にバックアップされません。定期的なバックアップを推奨します。

### 監視・アラート

本番環境では、アプリケーションの監視とアラート設定を推奨します。

## 🔄 Railwayアカウントの引き継ぎ方法（パターンCの場合）

納品先に完全に引き継ぐ場合の手順：

### 方法1: Railwayプロジェクトの所有権を移譲

1. Railwayのプロジェクト画面で「Settings」タブを開く
2. 「Team」セクションで納品先のメールアドレスを招待
3. 納品先が招待を受け入れる
4. 納品先を「Owner」に変更
5. 開発者側のアクセスを削除（オプション）

### 方法2: 納品先が新規にデプロイ

1. 納品先が新しいRailwayアカウントを作成
2. `DEPLOYMENT_GUIDE.md` に従ってデプロイ
3. 環境変数とサービスアカウントJSONを設定
4. デプロイ完了後、古いデプロイを停止（開発者側）

### 方法3: Railwayアカウントごと引き継ぎ

1. 開発者側のRailwayアカウントのメールアドレスを変更
2. 納品先のメールアドレスに変更
3. 納品先がパスワードをリセット
4. 納品先が完全に管理

**注意**: この方法は、開発者側が他のプロジェクトで同じRailwayアカウントを使っている場合は推奨しません。
