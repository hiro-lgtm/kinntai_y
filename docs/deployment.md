# デプロイ & 運用手順

## 1. 初期セットアップ
1. `Config.setSpreadsheetId('<スプレッドシートID>')` を実行し、勤怠テンプレートの ID を登録する（詳細は `docs/setup.md` を参照）。
2. 必要に応じて `.clasp.json` に Apps Script の Script ID を設定し、`clasp push` でコードをアップロードする。
3. GAS エディタでプロジェクトを開き、`Code.gs` 内の関数を一度実行して権限認可を完了する。

## 2. Web アプリとしての公開
1. GAS エディタから `デプロイ > 新しいデプロイ` を選択。
2. 種類で「ウェブアプリ」を選択し、以下を設定。
   - 実行するバージョン：新規作成
   - 実行するユーザー：自分（デプロイするユーザー）
   - アクセスできるユーザー：全員（ログイン画面で制御するため）
3. デプロイ後に表示される URL を従業員・管理者へ共有する。

## 3. スプレッドシート側の確認
1. `Employees` シートに従業員情報を登録し、`password_hash` には `UtilitiesService.hashPassword('平文パスワード')` で生成した値を貼り付ける。  
   - 初期パスワードを別途管理し、初回ログイン後の変更方法を周知する。
2. `AttendanceLog`, `DailySummary` などのシート名・列順がコードと一致しているか確認。
3. シート保護（パスワード等）を設定し、Apps Script のみが書き込む領域を明確化する。

## 4. 動作確認
1. 従業員ログイン画面からテストユーザーでログインし、出勤〜退勤までの打刻を一通り実施。
2. 管理者ページにアクセスし、集計カードと勤怠一覧が正しく更新されるかを確認。
3. アラートが出るケース（休憩未終了、退勤漏れ等）を意図的に作成し、管理者画面で検知できるかテスト。

## 5. 運用
1. **月次運用**  
   - 指定期間で集計を確認し、`CSV出力` ボタンでバックアップを取得。  
   - 必要な修正は管理者ページから行うか、`Config` + `SpreadsheetRepository.applyAttendanceAdjustment` を利用して修正履歴を残す。
2. **アカウント管理**  
   - 新入社員が追加された場合、`Employees` シートに追記し、パスワードハッシュを登録。  
   - 退職などで無効にする場合は `is_active` を `FALSE` に設定。
3. **メンテナンス**  
   - バージョンアップ時は `clasp push` → `デプロイ > バージョンを更新` の順に実施。  
   - バグや権限エラー発生時は `ErrorLog` シート（任意）や Stackdriver ログを確認。

## 6. トラブルシューティング
- ログインできない: `Employees` シートの ID / ハッシュ値、`is_active` を確認。  
- 打刻が反映されない: Spreadsheet ID の設定漏れやシート名ずれをチェック。  
- 管理画面の集計がおかしい: `DailySummary` の値を確認し、必要に応じて `SummaryService.updateDaily` を再実行。

